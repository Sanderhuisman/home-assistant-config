---
camera:
  - platform: mjpeg
    name: OctoPrint
    still_image_url: !secret octoprint_still_image_url
    mjpeg_url: !secret octoprint_mjpeg_url

  - platform: generic
    name: OctoPrint Preview
    # yamllint disable-line rule:line-length
    still_image_url: "http://192.168.1.9/plugin/UltimakerFormatPackage/thumbnail/{{states('sensor.octoprint_current_filename') | regex_replace(find='gcode', replace='png', ignorecase=True)}}"
    scan_interval: 5
    content_type: image/png

sensor:
  - platform: rest
    name: OctoPrint Current Filename
    resource: !secret octoprint_api_job
    headers:
      X-Api-Key: !secret octoprint_api_key
    value_template: '{{ value_json.job.file.path }}'

  - platform: template
    sensors:
      octoprint_time_remaining_hr:
        value_template: >-
          {% set time = (states('sensor.octoprint_time_remaining') | int(0)) %}
          {% set minutes = ((time % 3600) / 60) | int %}
          {% set hours = ((time % 86400) / 3600) | int %}
          {% set days = (time / 86400) | int %}

          {%- if time < 60 -%}
            Less than a minute
            {%- else -%}
            {%- if days > 0 -%}
              {{ days }}d
            {%- endif -%}
            {%- if hours > 0 -%}
              {%- if days > 0 -%}
                {{ ' ' }}
              {%- endif -%}
              {{ hours }}h
            {%- endif -%}
            {%- if minutes > 0 -%}
              {%- if days > 0 or hours > 0 -%}
                {{ ' ' }}
              {%- endif -%}
              {{ minutes }}m
            {%- endif -%}
          {%- endif -%}

      octoprint_time_elapsed_hr:
        value_template: >-
          {% set time = (states.sensor.octoprint_time_elapsed.state | int) | int %}
          {% set minutes = ((time % 3600) / 60) | int %}
          {% set hours = ((time % 86400) / 3600) | int %}
          {% set days = (time / 86400) | int %}

          {%- if time < 60 -%}
            Less than a minute
            {%- else -%}
            {%- if days > 0 -%}
              {{ days }}d
            {%- endif -%}
            {%- if hours > 0 -%}
              {%- if days > 0 -%}
                {{ ' ' }}
              {%- endif -%}
              {{ hours }}h
            {%- endif -%}
            {%- if minutes > 0 -%}
              {%- if days > 0 or hours > 0 -%}
                {{ ' ' }}
              {%- endif -%}
              {{ minutes }}m
            {%- endif -%}
          {%- endif -%}

      octoprint_time_ready:
        value_template: >
          {{ (now().strftime('%s') | int + states('sensor.octoprint_time_remaining') | int(0)) |
             timestamp_custom('%H:%M', false) }}

light:
  - platform: switch
    name: 3D Printer Lights
    entity_id: switch.printer_light
